<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Office - SSE Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-950 min-h-screen p-8 text-slate-200 font-sans">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-2">AI Office SSE Test</h1>
        <p class="text-slate-400 mb-8">Real-time agent status from Cloudflare Worker</p>

        <!-- Connection Status -->
        <div id="connectionStatus" class="mb-6 flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse" id="statusDot"></div>
            <span class="text-sm" id="statusText">Connecting...</span>
        </div>

        <!-- Agents Grid -->
        <div id="agentsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <!-- Agents will be rendered here -->
        </div>

        <!-- Raw Data -->
        <div class="mt-8">
            <button onclick="toggleRaw()" class="text-sm text-slate-500 hover:text-white mb-2">
                Toggle Raw Data
            </button>
            <pre id="rawData" class="hidden bg-slate-900 p-4 rounded-lg text-xs text-slate-400 overflow-auto max-h-64"></pre>
        </div>

        <!-- Last Update -->
        <div class="mt-4 text-xs text-slate-600" id="lastUpdate"></div>
    </div>

    <script>
        const WORKER_URL = 'https://openclaw.realrip.com';
        const TEAM_ID = 'yunhe-core';
        
        let eventSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connect() {
            const url = `${WORKER_URL}/api/sse/${TEAM_ID}`;
            
            console.log('Connecting to:', url);
            eventSource = new EventSource(url);
            
            eventSource.onopen = () => {
                console.log('SSE connected');
                updateStatus('connected', 'Live');
                reconnectAttempts = 0;
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data);
                    renderAgents(data);
                    document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('lastUpdate').textContent = 
                        `Last update: ${new Date().toLocaleTimeString()}`;
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };
            
            eventSource.onerror = (err) => {
                console.error('SSE error:', err);
                updateStatus('error', 'Disconnected');
                eventSource.close();
                
                // Reconnect with backoff
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    updateStatus('reconnecting', `Reconnecting in ${delay/1000}s...`);
                    setTimeout(connect, delay);
                } else {
                    updateStatus('failed', 'Connection failed');
                }
            };
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            const colors = {
                connected: 'bg-green-500',
                error: 'bg-red-500',
                reconnecting: 'bg-yellow-500',
                failed: 'bg-gray-500'
            };
            
            dot.className = `w-3 h-3 rounded-full ${colors[state] || 'bg-gray-500'} ${state === 'reconnecting' ? 'animate-pulse' : ''}`;
            statusText.textContent = text;
        }

        function renderAgents(data) {
            const grid = document.getElementById('agentsGrid');
            
            if (!data.agents || !Array.isArray(data.agents)) {
                grid.innerHTML = '<div class="text-slate-500">No agents data</div>';
                return;
            }
            
            grid.innerHTML = data.agents.map(agent => {
                const isOnline = agent.status === 'working';
                return `
                    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4 flex items-center gap-3 ${isOnline ? 'border-green-500/30' : ''}">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center font-semibold text-white"
                             style="background: ${agent.color}">
                            ${agent.name[0]}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-white">${agent.name}</div>
                            <div class="text-xs text-slate-500">${agent.role}</div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-slate-600'}"></div>
                            <span class="text-xs ${isOnline ? 'text-green-500' : 'text-slate-500'}">
                                ${agent.status}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleRaw() {
            const raw = document.getElementById('rawData');
            raw.classList.toggle('hidden');
        }

        // Start connection
        connect();
    </script>
</body>
</html>