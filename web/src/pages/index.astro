---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';

// Server-side data fetching for initial state
const WORKER_URL = 'https://openclaw.realrip.com';
const TEAM_ID = 'yunhe-core';

let initialData = { agents: [], timestamp: '' };

try {
  const response = await fetch(`${WORKER_URL}/api/agents/${TEAM_ID}`);
  if (response.ok) {
    initialData = await response.json();
  }
} catch (e) {
  console.error('Failed to fetch initial data:', e);
}

const workingCount = initialData.agents?.filter((a: any) => a.status === 'working').length || 0;
const totalCount = initialData.agents?.length || 6;
---

<Layout title="Openclaw Dashboard - Real-time Agent Monitoring">
  <!-- Header -->
  <header class="flex justify-between items-center px-8 py-6 border-b border-slate-800">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl flex items-center justify-center text-2xl shadow-lg">
        ðŸ¤–
      </div>
      <div>
        <h1 class="text-2xl font-bold text-white">Openclaw Dashboard</h1>
        <p class="text-sm text-slate-500">Real-time Agent Monitoring</p>
      </div>
    </div>
    
    <div class="flex items-center gap-8">
      <div class="text-center">
        <span class="block text-3xl font-bold text-white" id="activeCount">{workingCount}</span>
        <span class="text-xs text-slate-500 uppercase tracking-wider">Active</span>
      </div>
      
      <div class="text-center">
        <span class="block text-3xl font-bold text-white" id="totalCount">{totalCount}</span>
        <span class="text-xs text-slate-500 uppercase tracking-wider">Total</span>
      </div>
      
      <div class="flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-full">
        <span class="w-2 h-2 rounded-full bg-slate-600" id="connectionDot"></span>
        <span class="text-sm text-slate-400" id="connectionText">Connecting...</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-6 p-6 max-w-7xl mx-auto">
    <!-- Canvas Visualization -->
    <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl">
      <canvas id="officeCanvas" width="1200" height="700" class="w-full h-auto block"></canvas>
    </div>

    <!-- Agent Panel -->
    <div class="space-y-3" id="agentsPanel">
      {initialData.agents?.map((agent: any) => (
        <div class="agent-card flex items-center gap-3 p-4 bg-slate-900 border border-slate-800 rounded-xl transition-all hover:border-indigo-500"
          data-agent-id={agent.id}
          data-status={agent.status}
        >
          <div 
            class="w-11 h-11 rounded-xl flex items-center justify-center font-semibold text-white text-lg"
            style={`background: linear-gradient(135deg, ${agent.color}, ${agent.color}dd)`}
          >
            {agent.name[0]}
          </div>
          <div class="flex-1">
            <div class="font-semibold text-white">{agent.name}</div>
            <div class="text-xs text-slate-500">{agent.role}</div>
          </div>
          <div class={`flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold uppercase ${
            agent.status === 'working' 
              ? 'bg-green-500/15 text-green-500' 
              : 'bg-slate-600/15 text-slate-500'
          }`}>
            <span class={`w-1.5 h-1.5 rounded-full ${
              agent.status === 'working' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-slate-500'
            }`}></span>
            {agent.status}
          </div>
        </div>
      ))}
    </div>
  </main>

  <!-- Footer -->
  <footer class="flex justify-between items-center px-8 py-4 border-t border-slate-800 text-sm text-slate-500">
    <span>Openclaw Dashboard v1.0</span>
    <span id="lastUpdate">--</span>
  </footer>

  <script define:vars={{ initialData, WORKER_URL, TEAM_ID }}>
    // Agent configuration with positions
    const AGENTS = [
      { id: 'coder', name: 'Coder', color: '#3b82f6', x: 150, y: 250 },
      { id: 'writer', name: 'Writer', color: '#f43f5e', x: 400, y: 250 },
      { id: 'founder', name: 'Founder', color: '#a855f7', x: 650, y: 250 },
      { id: 'investor', name: 'Investor', color: '#f59e0b', x: 150, y: 450 },
      { id: 'coach', name: 'Coach', color: '#10b981', x: 400, y: 450 },
      { id: 'main', name: 'Main', color: '#06b6d4', x: 650, y: 450 }
    ];

    let eventSource = null;
    let reconnectAttempts = 0;

    function connectSSE() {
      const url = `${WORKER_URL}/api/sse/${TEAM_ID}`;
      eventSource = new EventSource(url);
      
      eventSource.onopen = () => {
        updateConnection(true);
        reconnectAttempts = 0;
      };
      
      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          updateDashboard(data);
        } catch (err) {
          console.error('Parse error:', err);
        }
      };
      
      eventSource.onerror = () => {
        updateConnection(false);
        eventSource.close();
        if (reconnectAttempts < 5) {
          reconnectAttempts++;
          setTimeout(connectSSE, Math.min(1000 * Math.pow(2, reconnectAttempts), 30000));
        }
      };
    }

    function updateConnection(connected) {
      const dot = document.getElementById('connectionDot');
      const text = document.getElementById('connectionText');
      
      if (connected) {
        dot.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]';
        text.textContent = 'Live';
        text.className = 'text-sm text-green-500';
      } else {
        dot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
        text.textContent = 'Reconnecting...';
        text.className = 'text-sm text-red-400';
      }
    }

    function updateDashboard(data) {
      // Update stats
      const working = data.agents?.filter(a => a.status === 'working').length || 0;
      document.getElementById('activeCount').textContent = working;
      document.getElementById('totalCount').textContent = data.agents?.length || 6;
      document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
      
      // Update agent cards
      data.agents?.forEach(agent => {
        const card = document.querySelector(`[data-agent-id="${agent.id}"]`);
        if (card) {
          const statusEl = card.querySelector('.agent-card > div:last-child');
          const dotEl = statusEl.querySelector('span');
          
          if (agent.status === 'working') {
            statusEl.className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold uppercase bg-green-500/15 text-green-500';
            dotEl.className = 'w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]';
            card.classList.add('border-green-500/30');
          } else {
            statusEl.className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold uppercase bg-slate-600/15 text-slate-500';
            dotEl.className = 'w-1.5 h-1.5 rounded-full bg-slate-500';
            card.classList.remove('border-green-500/30');
          }
          statusEl.lastChild.textContent = ` ${agent.status}`;
        }
      });
      
      // Update canvas
      drawOffice(data.agents);
    }

    function drawOffice(agents) {
      const canvas = document.getElementById('officeCanvas');
      const ctx = canvas?.getContext('2d');
      if (!ctx) return;
      
      // Clear
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw workstations
      AGENTS.forEach(agent => {
        const status = agents?.find(a => a.id === agent.id)?.status || 'idle';
        const isWorking = status === 'working';
        
        // Desk
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(agent.x, agent.y, 120, 80);
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.strokeRect(agent.x, agent.y, 120, 80);
        
        // Agent avatar
        const grad = ctx.createLinearGradient(agent.x, agent.y, agent.x + 120, agent.y + 80);
        grad.addColorStop(0, agent.color);
        grad.addColorStop(1, agent.color + 'dd');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(agent.x + 60, agent.y + 40, 25, 0, Math.PI * 2);
        ctx.fill();
        
        // Status ring
        ctx.strokeStyle = isWorking ? '#22c55e' : '#64748b';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(agent.x + 60, agent.y + 40, 30, 0, Math.PI * 2);
        ctx.stroke();
        
        // Initial
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(agent.name[0], agent.x + 60, agent.y + 47);
        
        // Label
        ctx.fillStyle = '#94a3b8';
        ctx.font = '12px Inter';
        ctx.fillText(agent.name, agent.x + 60, agent.y + 100);
      });
    }

    // Initialize
    drawOffice(initialData.agents);
    connectSSE();
  </script>
</Layout>
